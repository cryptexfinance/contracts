# CTX liquidity mining for Uniswap v3

Uniswap v3 replaced the old liquidity position ERC20 token with ERC-721 style NFT. Because of this our smart contract for Liquidity mining
was not compatible with Uniswap v3. 

### What is the new NFT style LP token about?

Uniswap V3 introduced the concept of concentrated liquidity positions which in brief means that liquidity providers can choose a custom 
price range for trading their tokens. Fees are distributed to LP tokens only when the price is in the position's range. All the metadata 
like the type of token pairs, the price range, the amount of liquidity provided, and the fees earned by each token is stored in the NFT.

### Algorithm for distributing rewards

Since fees are distributed only when the LP token is the position's range, rewards are also distributed in a similar way. For a detailed 
explanation of the algorithm please read this [article](https://www.paradigm.xyz/2021/05/liquidity-mining-on-uniswap-v3).
In short, the algorithm calculates the reward amount by diving the total unclaimed rewards by the total number of seconds for which fees
were generated by the LP token.

### The smart contract for liquidity mining for Uniswap v3

Uniswap Labs has created a smart contract for distributing rewards for liquidity mining. 
The code for it can be found [here](https://github.com/Uniswap/v3-staker). 


### Smart contract workflow

![Uniswap V3 liquidity mining workflow](./images/Uniswap-staking-workflow.png)


1. <ins>Create Incentive Program:</ins> The smart contract can be used to create several incentive programs to incentivize users to 
	 provide liquidity on uniswap v3 in return for rewards. Every incentive program has a unique identification key, a reward token, 
	 a pre-allocated reward amount, program start time, end time and the LP token pairs. The `Cryptex.Finance` DAO will create 
	 the incentive program for a token pair by providing the above mentioned details to the contract.
2. <ins>Deposit Token:</ins> Users can deposit their LP tokens before or after the incentive program starts. If a token is deposited
	 before the program starts then that token will not be considered as staked. A user can deposit all their LP tokens for the 
	 token pair the incentive programming is running for.
3. <ins>Stake Token:</ins> If a user deposits their LP tokens before the program starts then the user needs to stake every unstaked token 
	 so that they are considered for rewards distribution. A user can only stake tokens if the program is ongoing. The unique 
	 identification key of the incentive program is used to enter program. This detail will be hidden from the end user and it will be 
	 handled by the User Interface(UI).  
4. <ins>Unstake Token:</ins> A user must unstake their tokens in order to claim rewards. When a user unstakes, their rewards are calculated 
	 and their rewards balance gets updated. Any user who decides to claim their rewards midway during the program should unstake their 
	 tokens before claiming rewards.
5. <ins>Claim Rewards:</ins> A user can only claim tokens for a given LP token only if they've unstaked their token first. The reward 
	 tokens are transferred to the user when they claim their tokens and their rewards balance is reduced by the number of tokens claimed.
6. <ins>Re-stake Token:</ins> If a user unstaked their tokens for claiming rewards, then they can re-stake their tokens by 
	 following step `3`. 
7. <ins>Withdraw Token:</ins> A user can exit the program by withdrawing their tokens. They can only withdraw if they've 
	 unstaked their tokens. If a user decides to re-stake their tokens after withdrawing then they can follow step `2`.
8. <ins>Unstake Tokens Belonging To Other Users:</ins> Once the program is over anyone can unstake tokens belonging to other users. 
	 Please note that this only unstakes the tokens. It does not withdraw the tokens. This is helpful if the second condition of step `9` 
	 needs to be met.
9. <ins>End Incentive:</ins> The `Cryptex.Finance` DAO can end the incentive program after the program end time is over and collect any 
	 unclaimed rewards. Another pre-requisite for ending the program is that all users should unstake their tokens. Please refer to step `8`
	 to unstake tokens belonging to others.
 

### Technical Docs (WORK IN PROGRESS)
